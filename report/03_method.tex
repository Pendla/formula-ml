
\chapter{Method}

In order to evaluate how neuroevolution can be used to find racing behaviours a number of experiments will be conducted. The experiments require a controlled environment which can be reasoned about and where results can be reproduced. This chapter will cover the implementation of our experiment suite, which includes a racing simulator, an implementation of the NEAT-algorithm, a visualisation system and a control layer which connects the system components. Additionally the reasoning behind and implementation of the experiments that were conducted will be presented. 

\section{Requirements of the simulator}
% What kind of behaviour do we want to find?
% Desired behaviour -> put requirements on the simulation
% Simulation -> desired behaviour is optimal


The purpose of this study is to evaluate how well a machine learning algorithm can manage to learn the key aspects of an effective racing behaviour. Some of the aspects that will be evaluated are positioning throughout corners, timing and speed management. 

If the behaviour of the AI is to be assessed in comparison to real world racing theory, the optimal behaviour in the simulated environment must be similar to the optimal behaviour in reality. The simulation may approximate certain aspects or neglect details, as long as the general characteristics remain and the best practises in racing theory are still optimal. % Lite knölig mening. 

This requirement on the simulation introduces some constraints to the physics simulation. For example if positioning the car on the far side before taking a corner is to be optimal, the turning radius must increase with the speed of the car and accelerating or decelerating must be relatively slow. Taking a late apex before a straight will only be optimal if a larger initial speed onto a straight outperforms taking a smoother turn due to a slow acceleration rate. 

In order for not braking/accelerating and turning at the same time in tough regions of a curve to be optimal, the performance must be decreased.

...


\section{Simulator Implementation}
% Givet vårt beteende, hur evaluerar / analyserar vi saker i simulationen. Förklara vår sandlåda / universumet vi skapar.

The simulator consists of two vital components, the car and the track.

The tracks used in the simulator are flat 3D-meshes with triangle faces. The meshes were modelled in Autodesk Maya and were imported as OBJ-files. In order to simplify the representation of the track the cross sections of the track are extracted from the mesh. These cross sections are treated as a series of checkpoints that define the track.  

The car is modelled with these [insert] properties. The car is updated in constant size time steps and the following formulae are used [insert].

It is assumed that the presented model fulfil the requirements presented in section 1, and that it does not introduce aspects that in any other way changes the characteristics of the optimal behaviour.

\section{Visualisation ???}

\section{NEAT Implementation}

The NEAT algorithm was implemented in C++ primarily based on the descriptions in the original paper \cite{stanley:neat}. Two implementations were also used as references, the latest C++ implementation from the authors themselves \cite{neat_source} and a script written in Lua used in a Super Mario bot \cite{mario_source}. 

In order to verify the implementation of the algorithm it was tested by training it to approximate the logical exclusive-OR function (XOR). The reason that the XOR-function is relevant to test is because it is not linearly separable, this means that a neural network requires  hidden nodes  in order to approximate it \cite{haykin:xor, stanley:neat}. The test was used as a sanity check to ensure that the algorithm made additions and changes to the network structure. 

% Ta upp skilnaden mellan NEAT och fs-NEAT?
Some minor utility features were added to our implementation in order to allow for a more flexible training process. For example the activation function used in the neural networks is specified as a lambda-function, thus it can be changed at run-time. This enables us to specify what activation function should be used within a specific experiment. Furthermore the ability to toggle the creation of an initial structure for new networks was added. If the option is enabled, the genomes start with a lattice of connections that connect each input to each output with a randomised weight. 


\section{Training Process}
% Hur går vi till väga för att träna en AI, hur är AI och träning kopplat till resten av systemet
% Hur ser träningen ut:
% AIn styr bilen i varje simulation step
% Indata, förklara inte vilken typ av indata, säg bara vart den kommer ifrån.
% Slutgiltliga resultatet av simulationen ger feedback

This section will start to describe how a neural network is used in the simulator and will continue to describe how NEAT is used to train such networks. After a short overview over how the different parts relate to each other, two subsections will get into the details on what data the network works with and how a simulation is evaluated.

For each update of the simulator, the neural network is provided with data about the car and the track. The resulting values are then used to steer the car. The data will be described into detail in the "Interpretation" section.

When the neat algorithm run, new neural networks are produced and evaluated. When the network is evaluated, a car controlled by the network is simulated and run until it finishes the track or crashes. The result will be used to produce a fitness, used by the neat algorithm. How the fitness is calculated is presented in the "Evaluation" section.

\subsection{Interpretation - Make list or table?}
% Talk about how the environment is represented in relation to the neural network.
% How does the AI see the world? What does the inputs look like?
% What kind of output does the AI give to steer and control the vehicle?
% NOTE: Explain the potential solutions, but do not give away which one is being used in the final version, this conclusion needs to come from performing experiments and should thus be presented in the discussion & results.
% Problem modelling. 

This subsection will define different indata and output data for the neural networks that was used in different experiments. Not all of them was used for every experiment, but this section serve to be referenced, in order to avoid redundant descriptions.

Two different output values have been used in experiments, one for turning rate and one for acceleration and braking. 

The turning rate value has the range [-1, 1], where negative values means steering to the right and positive to the left. If the value exceed how much the car turn at the current speed, the car will only turn as much as it can.

The acceleration and braking value has the range [-1, 1]. Positive values mean that it should accelerate and negative values that it should brake. The value is a percentage of how much it it able to accelerate or brake.

When it comes to the different input values, the amount of different values are slightly larger.

Some of the optional values describe the current state of the car. One of the them is the speed of the car, measured in meters per second. Then values are used for the distance to the middle of the track and the distances to the right and left edge of the track. Another value is the angle between the direction of the car and the mid line of the track.

Another set of values describe the shape of the track ahead. One method used is consider the mid line of the track. It then picks points on that line with a fixed distance spacing, and takes the angles that separate the imaginary line segments between the point. In this way.


\subsection{Evaluation}
% Prata om fitness funktionen, men den behöver även "arbetas fram ur experimenten".. på något vis? Vi hade ju inte denna från början, den kom fram som en biprodukt av experimenten?
% Tänk också på läsaren, vad är lättast för den som läser att förstå
% Fitness functions

Running a simulation will give three values, the time the car was driving, the distance the car drove and how far the car came along the track. Worth noting is that the driven distance and the distance on the track is not necessarily the same, as the car may take curves on the inner and the outer side or drive in a serpentine.

How these three values are considered will effect what properties the neat will find. It is important to find a fitness function that not structurally encourage an unwanted behaviour.

The fitness function currently being used take firstly take in consideration the distance the car has went on the track. Secondly, if the car manages to around drive the complete track, the fitness will also increase the faster the car go.


\section{Experiments}
% Introduce the different experiment
% Overview
% Purpose of the experiments.
In order to achieve a great level of flexibility in the project, the process have been divided up into a sequence of experiments. These experiments allows for independently changing any part of the implementation such as the simulation, neural network, input/output data, learning algorithms and more.

% What is tested
% Purpose goal

% What we wanted to test
% What do we want to achieve by doing this experiment?
% How do we want to test this?
% Present the format:
    % - Input data
    % - Output data
    % - Fitness function
% How does a successful/failed result look like? 

\subsection{Steering with a fixed speed}
Let the car drive with a fixed speed. 

For in data, the AI will get the angle to mid line and the lateral position on the track. It will be tested with and without data on the curvature of the track and also for different speeds. 

This will give insight to how well the ai can interpret data and how a perception on the curvature changes the behaviour.


OLD (Bring up some of the stuff in R\&D?):

Controlling every aspect of the car can be very complicated for the neural network. This experiment aims to reduce that complexity by simplifying the problem in a way such that the neural network only has to control steering, while the car travels forward at a constant speed. The speed can of course be modified forcing the car to take specific race lines in order to complete a lap without crashing.

The goal of this experiment is to get a deeper understanding of how complex the problem at hand is, as well as evaluating the potential of the input and output data to and from the network that is related to steering the car. Examining this will present relevant information regarding what to expect once the complexity of the problem is increased. It should also help with deciding whether or not the way in which the track and steering actions are represented needs to be modified in any way, in order to increase network performance.

% TODO: Rewrite this once Training Process -> Interpretation has been written, so that we can refer back to that section. Note though that curve data should not be a part of this experiment.
The input data to the neural network in this experiment consists of the angle between the car and the mid line, curve data and the sum of the curve data absolute values as well as the current distance from the car to the mid line. The output that is produced by the network is an evenly distributed float value that ranges from $-1$ to $1$, representing full steering to the right and left respectively.

\subsection{Fixed speed with track curvature data - Remove}

OLD (Bring up some of the stuff in R\&D?):

In order to further increase the complexity of the problem and to examine the possibility of the AI to calculate an optimal race line, the aspect of planning ahead was introduced. The constant speed of the car was increased to a level were going around certain corners in the middle of the track, would not be possible. Thus forcing the network to position the car on a race line that has a larger radius than driving in the middle of the track. Performing this experiment should give some insight into the capabilities of the AI with regards to modifying race lines in order to take a complete lap. Even though the AI might not be able to take the most optimal route, seeing the capabilities of the race line modification could present some interesting information about potential problems or modifications needed.

In order to allow the network to plan ahead, a set of new inputs to the network was introduced. The concept of curve data, as explained in section 3.4.1 was provided to the network. Initially, the distance ahead covered by the new input data was 100 meters, but it was later expanded to 300 meters and 500 meters. Other than this change in input data, the inputs and outputs of the network were the same as in the fixed speed experiment.

A successful experiment will present us with a network that modifies the race line in such a way that it is wide enough for the car to make a complete lap, at a speed that does not allow this in the middle of track. 


\subsection{(Speed control with existing steer controller)}

\subsection{Steer and speed control}
For this experiment, the ai will also be able to control acceleration and braking. In addition to local positioning and the curvature of the track, the car will also get the speed of the car.
The ai will be tested on a large track and single curve segments. This will show how well it manages both steering and speed control.

\subsection{Multiple short track segments}
Instead of driving a long track, evaluate with a couple of short track segments. For a long track, failing in one early curve affect the whole result. Testing several short segments may let the car progress in a later curve, before an early on is completed.

It will also be tested to alternate which of the track segments are used for the evaluation. Will this let networks progress further, since a temporary decline in some curves will not be noticed? 
